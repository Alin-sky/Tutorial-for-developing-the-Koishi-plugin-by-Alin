# ç®€å•çš„å›¾ç‰‡æ¸²æŸ“

> koishiæœ¬åœ°åŸç”Ÿå®ç°å›¾ç‰‡æ¸²æŸ“æœ‰ä¸¤ç§æ–¹æ³•
> - puppeteer
> - canvas

å½“ç„¶è¿˜æœ‰å…¶ä»–ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¦‚jimpï¼Œæœ¬æ•™ç¨‹æš‚æ—¶åªè®¨è®ºç¤¾åŒºç”¨çš„å¤šçš„puppeteerå’Œcanvasæ–¹æ³•

### puppeteerå’Œcanvasçš„ä¼˜åŠ£ï¼š

!> æ­¤å¤„ä¼˜åŠ£æ€»ç»“ä¸ºä¸ªäººè§‚ç‚¹

**puppeteer**
- ä¼˜ç‚¹
  - å¯¹äºç²¾é€šHTMLçš„äººæ›´å‹å¥½
- ç¼ºç‚¹
  - æ¸²æŸ“é€Ÿåº¦ç›¸æ¯”canvasè¦æ…¢
  - cssæ ·å¼çš„ç®¡ç†å¤æ‚

**Canvas**
- ä¼˜ç‚¹
  - å‡ºå›¾é€Ÿåº¦è¾ƒå¿«
  - å¯ä»¥å°è£…æˆä¸€ä¸ªä¸ªå‡½æ•°ï¼Œæ˜“è¯»æ€§æ›´å¼º
- ç¼ºç‚¹
  - å®‰è£…åŸç”Ÿcanvasæ’ä»¶æ¯”è¾ƒéº»çƒ¦
  - ä½¿ç”¨é€»è¾‘å’Œhtmlæœ‰ä¸€äº›ä¸åŒ

## Canvasæ–¹æ³•

!> **canvasçš„æ•™ç¨‹æ˜¯ä½œè€…ä½¿ç”¨canvasæƒ¯ç”¨çš„å†™æ³•ï¼Œä¸ä»£è¡¨å”¯ä¸€æ–¹æ³•ï¼Œä¹Ÿä¸æ˜¯ç»å¯¹æ­£ç¡®çš„æ–¹æ³•**

### åŠ è½½canvas

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¯åŠ¨ä¸€ä¸‹canvasæ’ä»¶ï¼Œåœ¨`æ’ä»¶å¸‚åœº`æœç´¢`canvas`å®‰è£…å¹¶å¯åŠ¨

ï¼ˆæ­¤è¿‡ç¨‹ä¸å†èµ˜è¿°ï¼Œé»˜è®¤éƒ½æ˜¯koishié«˜æ‰‹ï¼‰

å›åˆ°æˆ‘ä»¬çš„vscodeï¼Œæˆ‘ä»¬æ·»åŠ canvasçš„ä¾èµ–

```js
import { Image } from '@koishijs/canvas';
export const inject = { required: ['canvas']}
```
å¦‚æœvscodeæ²¡æœ‰ä»€ä¹ˆçº¢çš„æŠ¥é”™å°±æ˜¯åŠ è½½å®Œæˆäº†

### canvasç»˜åˆ¶

æ¯”å¦‚æˆ‘ä»¬ç°åœ¨è¦ç”»ä¸€ä¸ªä»‹ç»æœºå™¨äººçš„å¡ç‰‡å›¾

æˆ‘ä»¬æƒ³è¦ï¼š
- åœ†å½¢å¤´åƒæ¡†
- åœ†è§’çŸ©å½¢å¡ç‰‡
- ä¸åŒå¤§å°ã€é¢œè‰²å’Œä½ç½®çš„æ–‡å­—
- åˆ†å‰²çº¿

æˆ‘ä»¬å¯ä»¥å°†è¿™å‡ ä¸ªæ­¥éª¤å°è£…æˆå‡ ä¸ªå‡½æ•°

æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šç”¨æ³¨é‡Šå’Œå®ä¾‹ä»£ç æ¥è®²è§£å¦‚ä½•åˆ¶ä½œä»¥ä¸Šéœ€æ±‚çš„å›¾ç‰‡

ç¡®ä¿åœ¨æˆ‘ä»¬çš„`apply`å‡½æ•°å†…

#### åœ†å½¢å¤´åƒåˆ›å»º
```js
  /**
   * å¤´åƒåˆ›å»ºå‡½æ•°
   * @param img_url å¤´åƒçš„å›¾ç‰‡é“¾æ¥ 
   */
  async function create_avatar(img_url: string) {
    //ä½¿ç”¨ctx.canvas.loadImageåŠ è½½å›¾ç‰‡
    const ava_img = await ctx.canvas.loadImage(img_url)
    //åˆ›å»ºä¸€ä¸ª500x500çš„ç”»å¸ƒ
    const canvass = await ctx.canvas.createCanvas(500, 500)
    //è·å–ç”»å¸ƒçš„2Dç»˜å›¾ä¸Šä¸‹æ–‡
    //è¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡æä¾›äº†ç”¨äºåœ¨ç”»å¸ƒä¸Šç»˜åˆ¶å›¾å½¢å’Œå›¾åƒçš„æ–¹æ³•å’Œå±æ€§
    const ctximg = canvass.getContext("2d")
    // è®¾ç½®åœ†è§’çš„åŠå¾„
    const radius = 250; // è¿™é‡Œè®¾ç½®ä¸º250ï¼Œæ„å‘³ç€å¤´åƒå°†æ˜¯ä¸€ä¸ªå®Œæ•´çš„åœ†å½¢
    // å¼€å§‹ç»˜åˆ¶åœ†è§’è·¯å¾„
    //å¼€å§‹ä¸€æ¡æ–°çš„è·¯å¾„ã€‚ç”¨äºå®šä¹‰ä¸€ä¸ªæ–°çš„ç»˜å›¾è·¯å¾„ï¼Œæ¸…é™¤ä¹‹å‰çš„è·¯å¾„ã€‚
    ctximg.beginPath();
    //ç»˜åˆ¶ä¸€ä¸ªåœ†å¼§è·¯å¾„ã€‚è¿™é‡Œçš„å‚æ•°å®šä¹‰äº†åœ†å¿ƒåœ¨ (250, 250)ï¼ŒåŠå¾„ä¸º radiusï¼Œä»è§’åº¦ 0 åˆ° 2Ï€ï¼ˆå®Œæ•´çš„åœ†ï¼‰ã€‚
    ctximg.arc(250, 250, radius, 0, Math.PI * 2, true);
    //é—­åˆå½“å‰è·¯å¾„ã€‚å°†è·¯å¾„çš„èµ·ç‚¹å’Œç»ˆç‚¹è¿æ¥èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„å½¢çŠ¶ã€‚
    ctximg.closePath();
    // è£å‰ªç”»å¸ƒï¼Œåªåœ¨åœ†å½¢åŒºåŸŸå†…ç»˜åˆ¶
    ctximg.clip();
    // åœ¨è£å‰ªçš„åœ†å½¢åŒºåŸŸå†…ç»˜åˆ¶å›¾ç‰‡
    ctximg.drawImage(ava_img, 0, 0, 500, 500);
    // å°†ç”»å¸ƒè½¬æ¢ä¸ºbuffer
    const buffer = canvass.toBuffer("image/png")
    // å‡½æ•°è¿”å›è¿™ä¸ªbuffer
    return buffer
  }
```

æˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹å§

```js
import { Context, h/*æ›´æ–°hå‡½æ•°å¯¼å…¥*/, Schema } from 'koishi'/*æ›´æ–°hå‡½æ•°å¯¼å…¥*/
//ç®€å•çš„æŒ‡ä»¤
  ctx.command("canvas")
    .action(async () => {
      const img = await create_avatar("https://static.kivo.wiki/images/students/%E5%A4%A9%E7%AB%A5%20%E7%88%B1%E4%B8%BD%E4%B8%9D/avatar.png")
      return h.image(img, "image/png")
    })
```

<div class="chat-container">
  <div class="chat-message user">
    <div class="avatar user-avatar"></div>
    <div class="bubble">
      <p>canvas</p>
    </div>
  </div>
  <div class="chat-message bot">
    <img src="https://cdnimg-v2.gamekee.com/wiki2.0/images/w_400/h_400/829/43637/2024/9/10/931062.png" alt="Bot Avatar" class="avatar bot-avatar">
    <div class="bubble">
      <canvas id="myCanvas" width="200" height="200" style="border:0px solid #000000;"></canvas>
    </div>
  </div>
</div>

#### åœ†è§’çŸ©å½¢åˆ›å»º

```js
async function create_background() {
    // åˆ›å»ºä¸€ä¸ª500x250çš„ç”»å¸ƒ
    const canvass = await ctx.canvas.createCanvas(500, 250);
    // è·å–ç”»å¸ƒçš„2Dç»˜å›¾ä¸Šä¸‹æ–‡
    const c = canvass.getContext("2d");
    // å®šä¹‰ä¸€ä¸ªç»˜åˆ¶åœ†è§’çŸ©å½¢çš„å‡½æ•°
    function drawRoundedRect(x, y, width, height, radius) {
        // å¼€å§‹ç»˜åˆ¶è·¯å¾„
        c.beginPath();
        // ç§»åŠ¨åˆ°çŸ©å½¢çš„èµ·å§‹ç‚¹
        c.moveTo(x + radius, y);
        // ç»˜åˆ¶é¡¶éƒ¨è¾¹ç¼˜çš„ç›´çº¿
        c.lineTo(x + width - radius, y);
        // ç»˜åˆ¶å³ä¸Šè§’çš„åœ†è§’
        c.quadraticCurveTo(x + width, y, x + width, y + radius);
        // ç»˜åˆ¶å³ä¾§è¾¹ç¼˜çš„ç›´çº¿
        c.lineTo(x + width, y + height - radius);
        // ç»˜åˆ¶å³ä¸‹è§’çš„åœ†è§’
        c.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
        // ç»˜åˆ¶åº•éƒ¨è¾¹ç¼˜çš„ç›´çº¿
        c.lineTo(x + radius, y + height);
        // ç»˜åˆ¶å·¦ä¸‹è§’çš„åœ†è§’
        c.quadraticCurveTo(x, y + height, x, y + height - radius);
        // ç»˜åˆ¶å·¦ä¾§è¾¹ç¼˜çš„ç›´çº¿
        c.lineTo(x, y + radius);
        // ç»˜åˆ¶å·¦ä¸Šè§’çš„åœ†è§’
        c.quadraticCurveTo(x, y, x + radius, y);
        // ç»“æŸè·¯å¾„
        c.closePath();
    }
    // åˆ›å»ºçº¿æ€§æ¸å˜
    const gradient = c.createLinearGradient(0, 0, 400, 0);
    // è®¾ç½®æ¸å˜çš„èµ·å§‹é¢œè‰²
    gradient.addColorStop(0, "#67a1ff");
    // è®¾ç½®æ¸å˜çš„ç»“æŸé¢œè‰²
    gradient.addColorStop(1, "#00c3ff");
    // è®¾ç½®å¡«å……æ ·å¼ä¸ºæ¸å˜
    c.fillStyle = gradient;
    // ç»˜åˆ¶åœ†è§’çŸ©å½¢
    drawRoundedRect(0, 0, 500, 250, 40);
    // å¡«å……çŸ©å½¢
    c.fill();
    // å°†ç”»å¸ƒè½¬æ¢ä¸ºPNGæ ¼å¼çš„Buffer
    const buffer = canvass.toBuffer("image/png");
    // è¿”å›è¿™ä¸ªBuffer
    return buffer;
}

```
!> `.addColorStop`çš„å…¼å®¹æ€§æœªéªŒè¯

éªŒè¯ä¸€ä¸‹å§
```js
import { Context, h, Schema } from 'koishi'
  ctx.command("canvas")
    .action(async () => {
      const img = await create_background()
      return h.image(img, "image/png")
    })
```
<div class="chat-container">
  <div class="chat-message user">
    <div class="avatar user-avatar"></div>
    <div class="bubble">
      <p>canvas</p>
    </div>
  </div>
  <div class="chat-message bot">
    <img src="https://cdnimg-v2.gamekee.com/wiki2.0/images/w_400/h_400/829/43637/2024/9/10/931062.png" alt="Bot Avatar" class="avatar bot-avatar">
    <div class="bubble">
        <canvas id="myCanvas-1" width="500" height="250"></canvas>
    </div>
  </div>
</div>

> éªŒè¯çš„æ–¹æ³•éƒ½ä¸€æ ·ï¼Œä¹‹åä¸åœ¨èµ˜è¿°

#### æ–‡å­—ç»˜åˆ¶

```js
  /**
   * æ–‡å­—ç»˜åˆ¶å‡½æ•°
   * @param text æ–‡æœ¬å†…å®¹
   * @param size å­—ä½“å¤§å°
   */
  async function create_text(text: string, size: number) {
    // è®¡ç®—æ–‡æœ¬å®½åº¦ï¼Œå‡è®¾æ¯ä¸ªå­—ç¬¦å®½åº¦ä¸ºå­—ä½“å¤§å°çš„ä¸€åŠ
    const charWidth = size ;
    const textWidth = text.length * charWidth;
    // è®¡ç®—æ–‡æœ¬é«˜åº¦ï¼Œå‡è®¾é«˜åº¦ä¸ºå­—ä½“å¤§å°çš„1.5å€
    const textHeight = size * 1.5;
    // åˆ›å»ºä¸€ä¸ªåˆé€‚å¤§å°çš„ç”»å¸ƒ
    const canvass = await ctx.canvas.createCanvas(textWidth + 20, textHeight + 20);
    const c = canvass.getContext("2d");
    // è®¾ç½®å­—ä½“å¤§å°å’Œæ ·å¼
    c.font = `${size}px Arial`;
    c.textAlign = "center";
    c.textBaseline = "middle";
    c.fillStyle = "#000000";
    // è®¡ç®—æ–‡æœ¬ç»˜åˆ¶ä½ç½®
    const x = canvass.width / 2;
    const y = canvass.height / 2;
    // ç»˜åˆ¶æ–‡æœ¬
    c.fillText(text, x, size);
    // å°†ç”»å¸ƒè½¬æ¢ä¸ºPNGæ ¼å¼çš„Buffer
    const buffer = canvass.toBuffer("image/png");
    return buffer;
  }
```


<div class="chat-container">
  <div class="chat-message user">
    <div class="avatar user-avatar"></div>
    <div class="bubble">
      <p>canvas</p>
    </div>
  </div>
  <div class="chat-message bot">
    <img src="https://cdnimg-v2.gamekee.com/wiki2.0/images/w_400/h_400/829/43637/2024/9/10/931062.png" alt="Bot Avatar" class="avatar bot-avatar">
    <div class="bubble">
        <canvas id="textCanvas"></canvas>
    </div>
  </div>
</div>


#### åˆæˆ

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æŠŠæˆ‘ä»¬çš„æ¯ä¸ªå›¾å±‚çš„åˆæˆåœ¨ä¸€ä¸ªcanvasä¸Š

### puppeteerç»˜åˆ¶



```js

  async function create_img() {
    //åŠ è½½å¤´åƒï¼Œä»£ç æ•´åˆæˆäº†ä¸€æ•´è¡Œ
    const ava_img = await ctx.canvas.loadImage(await create_avatar("https://static.kivo.wiki/images/students/%E5%A4%A9%E7%AB%A5%20%E7%88%B1%E4%B8%BD%E4%B8%9D/avatar.png"))
    //åŠ è½½èƒŒæ™¯
    const back_img = await ctx.canvas.loadImage(await create_background())
    //åˆ›å»º1200x600çš„ç”»å¸ƒ
    const canvass = await ctx.canvas.createCanvas(1200, 600);
    //åˆ›å»ºå¹¶åŠ è½½å„ç§æ–‡å­—
    const t1 = await ctx.canvas.loadImage(await create_text("å‹‡è€…çˆ±ä¸½ä¸", 100))
    const t2 = await ctx.canvas.loadImage(await create_text("æœºé¾„ï¼š3å¹´ï¼Ÿ", 40))
    const t3 = await ctx.canvas.loadImage(await create_text("çˆ±å¥½ï¼šç©æ¸¸æˆï¼Œå’Œè€å¸ˆå»å†’é™©", 40))
    const t4 = await ctx.canvas.loadImage(await create_text("æœ€å–œæ¬¢çš„ä¸œè¥¿ï¼šå‰ç¥¥ç‰©è€å¸ˆ", 40))
    const t5 = await ctx.canvas.loadImage(await create_text("æœ€å–œæ¬¢çš„é£Ÿç‰©ï¼šèŠ­è²ï¼", 40))
    const t6 = await ctx.canvas.loadImage(await create_text("æœ€å–œæ¬¢çš„é¥®æ–™ï¼šWD40?", 40))
    const t7 = await ctx.canvas.loadImage(await create_text("â€œé‚¦é‚¦å’”é‚¦ï¼â€", 30))
    const t8 = await ctx.canvas.loadImage(await create_text("æœ€å–œæ¬¢çš„åŠ¨ç‰©ï¼šå°çŒ«å’ªğŸ±", 40))
    //ç»§æ‰¿ä¸Šä¸‹æ–‡
    const c = canvass.getContext("2d");
    //å¼€å§‹æ’ç‰ˆ
    //c.drawImage(canvasç”»å¸ƒ, xåæ ‡, yåæ ‡, hç¼©æ”¾, yç¼©æ”¾)
    c.drawImage(back_img, 0, 0, 1200, 600)
    c.drawImage(ava_img, 40, 40, 170, 170)
    c.drawImage(ava_img, 40, 40, 170, 170)
    c.drawImage(t1, 250, 30,)
    c.drawImage(t2, 30, 230,)
    c.drawImage(t3, 40, 300,)
    c.drawImage(t4, 40, 370,)
    c.drawImage(t5, 700, 230,)
    c.drawImage(t6, 665, 300,)
    c.drawImage(t7, 900, 500,)
    c.drawImage(t8, 690, 370,)
    //ç”»çº¿æ¡
    c.strokeStyle = '#0000ff'; // çº¿æ¡é¢œè‰²
    c.lineWidth = 8; // çº¿æ¡å®½åº¦
    // ç»˜åˆ¶ç«–çº¿
    c.beginPath();
    c.moveTo(620, 230); // èµ·ç‚¹
    c.lineTo(620, 500); // ç»ˆç‚¹
    c.stroke();
    // ç»˜åˆ¶æ¨ªçº¿
    c.strokeStyle = '#66ccff'; // çº¿æ¡é¢œè‰²
    c.lineWidth = 6; // çº¿æ¡å®½åº¦
    c.beginPath();
    c.moveTo(260, 200); // èµ·ç‚¹
    c.lineTo(1000, 200); // ç»ˆç‚¹
    c.stroke();
    // å°†ç”Ÿæˆçš„å›¾ç‰‡ä¿å­˜buffer
    const buffer = canvass.toBuffer('image/png');
    return buffer
  }
```

æœ€ç»ˆæ•ˆæœ

![img](https://docs-1317895529.cos.ap-guangzhou.myqcloud.com/img46.png ':size=70%')

<script>
async function drawAvatar() {
    const c = document.getElementById("myCanvas");
    const ctx = c.getContext("2d");
    const imgava = await loadImage("https://static.kivo.wiki/images/students/%E5%A4%A9%E7%AB%A5%20%E7%88%B1%E4%B8%BD%E4%B8%9D/avatar.png");
    const radius = 100;
    ctx.beginPath();
    ctx.arc(100, 100, radius, 0, Math.PI * 2, true);
    ctx.closePath();
    ctx.clip();
    ctx.drawImage(imgava, 0, 0, 200, 200);
}
function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
    });
}
drawAvatar();

function drawRoundedRect(ctx, x, y, width, height, radius) {
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.lineTo(x + width - radius, y);
    ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
    ctx.lineTo(x + width, y + height - radius);
    ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
    ctx.lineTo(x + radius, y + height);
    ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
    ctx.lineTo(x, y + radius);
    ctx.quadraticCurveTo(x, y, x + radius, y);
    ctx.closePath();
}

function drawGradientCard() {
    const canvas = document.getElementById("myCanvas-1");
    const ctx = canvas.getContext("2d");

    // åˆ›å»ºçº¿æ€§æ¸å˜
    const gradient = ctx.createLinearGradient(0, 0, 400, 0);
    gradient.addColorStop(0, "#67a1ff");
    gradient.addColorStop(1, "#00c3ff");

    // åº”ç”¨æ¸å˜å¹¶ç»˜åˆ¶åœ†è§’çŸ©å½¢
    ctx.fillStyle = gradient;
    drawRoundedRect(ctx,0, 0, 500, 250, 40);
    ctx.fill();
}

drawGradientCard();

    function createTextCanvas(text, size) {
        // åˆ›å»ºä¸€ä¸ªéšè—çš„ç”»å¸ƒæ¥è®¡ç®—æ–‡æœ¬å®½åº¦
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.font = `${size}px Arial`;
        // è®¡ç®—æ–‡æœ¬å®½åº¦å’Œé«˜åº¦
        const textWidth = tempCtx.measureText(text).width;
        const textHeight = size * 1.5;
        // è®¾ç½®ç”»å¸ƒå¤§å°
        const canvas = document.getElementById('textCanvas');
        canvas.width = textWidth + 20;
        canvas.height = textHeight + 20;
        const ctx = canvas.getContext('2d');
        // è®¾ç½®å­—ä½“å’Œæ ·å¼
        ctx.font = `${size}px Arial`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = '#000000';
        // ç»˜åˆ¶æ–‡æœ¬
        const x = canvas.width / 2;
        const y = canvas.height / 2;
        ctx.fillText(text, x, y);
        }
        // è°ƒç”¨å‡½æ•°ç»˜åˆ¶æ–‡æœ¬
createTextCanvas('è¿™æ˜¯ä¸€æ®µç¤ºä¾‹æ–‡æœ¬', 30);
</script>
